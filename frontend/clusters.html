<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Duplicate Clusters – Clearoid</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>tailwind.config = { darkMode: 'class' }</script>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<script src="https://unpkg.com/vis-network@9.1.2/standalone/umd/vis-network.min.js"></script>
	<style>
		body {
			font-family: 'Inter', -apple-system, sans-serif;
		}

		#network {
			height: 80vh;
			border-radius: 2rem;
		}
	</style>
</head>

<body class="bg-gray-50 dark:bg-black min-h-screen text-gray-900 dark:text-gray-100">
	<div class="max-w-7xl mx-auto p-8">
		<!-- Header -->
		<div class="text-center mb-12">
			<h1 class="text-5xl font-bold">Duplicate Clusters</h1>
			<p class="mt-4 text-xl text-gray-600 dark:text-gray-400">
				Visual map of all semantically similar titles
			</p>
		</div>

		<!-- Stats -->
		<div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
			<div
				class="bg-white dark:bg-gray-900 rounded-3xl p-10 shadow-2xl border border-gray-200 dark:border-gray-800 text-center">
				<p class="text-6xl font-bold text-purple-600" id="clusterCount">0</p>
				<p class="text-xl text-gray-600 dark:text-gray-400 mt-2">Clusters Found</p>
			</div>
			<div
				class="bg-white dark:bg-gray-900 rounded-3xl p-10 shadow-2xl border border-gray-200 dark:border-gray-800 text-center">
				<p class="text-6xl font-bold text-amber-600" id="totalDupes">0</p>
				<p class="text-xl text-gray-600 dark:text-gray-400 mt-2">Duplicate Titles</p>
			</div>
			<div
				class="bg-white dark:bg-gray-900 rounded-3xl p-10 shadow-2xl border border-gray-200 dark:border-gray-800 text-center">
				<p class="text-6xl font-bold text-blue-600" id="largestCluster">0</p>
				<p class="text-xl text-gray-600 dark:text-gray-400 mt-2">Largest Group</p>
			</div>
		</div>

		<!-- Graph -->
		<div
			class="bg-white dark:bg-gray-900 rounded-3xl shadow-2xl overflow-hidden border border-gray-200 dark:border-gray-800">
			<div id="network"></div>
		</div>

		<!-- Empty State -->
		<div id="empty" class="text-center py-20 text-3xl text-gray-400 hidden">
			No duplicate clusters yet — all titles are unique!
		</div>
	</div>

	<script>
		const container = document.getElementById("network");
		const empty = document.getElementById("empty");

		async function loadClusters() {
			try {
				const res = await fetch("/webhook/clusters");
				const groups = await res.json();

				if (!groups.length) {
					empty.classList.remove("hidden");
					container.style.display = "none";
					return;
				}

				empty.classList.add("hidden");
				container.style.display = "block";

				const nodes = [];
				const edges = [];
				let nodeId = 1;
				let totalDupes = 0;
				let largest = 0;

				const colors = ["#3b82f6", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6", "#ec4899", "#06b6d4"];

				groups.forEach((cluster, i) => {
					const color = colors[i % colors.length];
					const clusterNodes = [];

					cluster.titles.forEach(t => {
						nodes.push({
							id: nodeId,
							label: t.title,
							color: { background: color + '22', border: color, highlight: { background: color + '44', border: color } },
							font: { color: 'gray-800', size: 16 },
							shape: 'dot',
							size: 20 + t.title.length
						});
						clusterNodes.push(nodeId);
						nodeId++;
					});

					totalDupes += cluster.titles.length;
					largest = Math.max(largest, cluster.titles.length);

					// Connect all nodes in cluster
					for (let a = 0; a < clusterNodes.length; a++) {
						for (let b = a + 1; b < clusterNodes.length; b++) {
							edges.push({ from: clusterNodes[a], to: clusterNodes[b], color: color + '44' });
						}
					}
				});

				document.getElementById("clusterCount").textContent = groups.length;
				document.getElementById("totalDupes").textContent = totalDupes;
				document.getElementById("largestCluster").textContent = largest;

				const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
				const options = {
					physics: { stabilization: false, barnesHut: { gravitationalConstant: -8000 } },
					nodes: { shadow: true },
					edges: { smooth: false, width: 2 },
				};
				new vis.Network(container, data, options);
			} catch (e) {
				empty.textContent = "Error loading clusters";
				empty.classList.remove("hidden");
			}
		}
    }

		loadClusters();
		setInterval(loadClusters, 15000); // Refresh every 15s
	</script>
</body>

</html>